<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM-VRF: Lightweight Mobile VRF Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .feature {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .feature-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .feature-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .demo-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .demo-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
            margin-bottom: 15px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .output {
            background: #2d3748;
            color: #a0aec0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .output .success {
            color: #48bb78;
        }

        .output .error {
            color: #f56565;
        }

        .output .highlight {
            color: #4fd1c5;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .alert strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .feature-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ LM-VRF Interactive Demo</h1>
        <p class="subtitle">Lightweight Mobile Verifiable Random Function - Running in Your Browser</p>

        <div class="feature-grid">
            <div class="feature">
                <div class="feature-value">2-5ms</div>
                <div class="feature-label">Verification Time</div>
            </div>
            <div class="feature">
                <div class="feature-value">20-50√ó</div>
                <div class="feature-label">Faster than VRF</div>
            </div>
            <div class="feature">
                <div class="feature-value">< 1KB</div>
                <div class="feature-label">Memory Usage</div>
            </div>
        </div>

        <div class="alert" id="browserAlert" style="display: none;">
            <strong>‚ö†Ô∏è Browser Compatibility Note</strong>
            Your browser may not support Ed25519 signatures. The demo will run in algebraic-only mode.
        </div>

        <div class="demo-section">
            <h2>üéÆ Demo 1: Mobile Gaming Loot Box</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Simulate a provably fair loot box opening with instant on-device verification.
            </p>
            <button onclick="demoLootBox()">üéÅ Open Loot Box</button>
            <div id="lootboxOutput" class="output">Ready to open loot box...</div>
        </div>

        <div class="demo-section">
            <h2>‚ö° Demo 2: Performance Benchmark</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Run 100 verifications and compare with traditional VRF performance.
            </p>
            <button onclick="runBenchmark()" id="benchmarkBtn">‚ö° Run Benchmark</button>
            <div id="benchmarkOutput" class="output">Click to run benchmark...</div>
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-box">
                    <div class="stat-value" id="avgTime">-</div>
                    <div class="stat-label">Avg Time (ms)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="speedup">-</div>
                    <div class="stat-label">vs Pairing VRF</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="throughput">-</div>
                    <div class="stat-label">Verifications/sec</div>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>üõ°Ô∏è Demo 3: Attack Resistance</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Test LM-VRF's resistance to manipulation and tampering attempts.
            </p>
            <button onclick="testAttacks()">üõ°Ô∏è Test Security</button>
            <div id="attackOutput" class="output">Click to test attack resistance...</div>
        </div>

        <div class="demo-section">
            <h2>üî¢ Demo 4: Generate Your Own Random Number</h2>
            <p style="margin-bottom: 15px; color: #666;">
                Generate a verifiable random number with your own context.
            </p>
            <input type="text" id="contextInput" placeholder="Enter context (e.g., 'my_app_session_123')" 
                   style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; font-size: 1em;">
            <button onclick="generateCustom()">üé≤ Generate Random Number</button>
            <div id="customOutput" class="output">Enter a context and click generate...</div>
        </div>
    </div>

    <script>
        // Inline the LM-VRF implementation
        class LightweightMobileVRF {
            constructor(epsilon = 1e-8) {
                this.epsilon = epsilon;
                this.stats = { verifications: 0, avgVerifyTime: 0, totalTime: 0 };
            }

            verifyAlgebraicIdentity(a, b) {
                if (Math.abs(b - (a + 1)) > this.epsilon) return false;
                const leftSide = a + (a * a) + b;
                const rightSide = b * b;
                return Math.abs(leftSide - rightSide) <= this.epsilon;
            }

            async generate(context, privateKey = null, minVal = -1000, maxVal = 1000) {
                const range = maxVal - minVal;
                const randomBytes = new Uint32Array(1);
                crypto.getRandomValues(randomBytes);
                const a = minVal + (randomBytes[0] / 0xFFFFFFFF) * range;
                const b = a + 1;

                if (!this.verifyAlgebraicIdentity(a, b)) {
                    throw new Error('Algebraic identity verification failed');
                }

                let signature = null;
                if (privateKey) {
                    const message = `${a}:${b}:${context}`;
                    const data = new TextEncoder().encode(message);
                    try {
                        signature = await crypto.subtle.sign('Ed25519', privateKey, data);
                    } catch (e) {
                        console.warn('Signature creation failed:', e);
                    }
                }

                return { a, b, signature, context, timestamp: Date.now() };
            }

            async verify(proof, publicKey = null) {
                const startTime = performance.now();
                
                if (!this.verifyAlgebraicIdentity(proof.a, proof.b)) {
                    return false;
                }

                if (publicKey && proof.signature) {
                    const message = `${proof.a}:${proof.b}:${proof.context}`;
                    const data = new TextEncoder().encode(message);
                    try {
                        const isValid = await crypto.subtle.verify('Ed25519', publicKey, proof.signature, data);
                        if (!isValid) return false;
                    } catch (e) {
                        console.warn('Signature verification failed:', e);
                        return false;
                    }
                }

                const endTime = performance.now();
                const verifyTime = endTime - startTime;
                this.stats.verifications++;
                this.stats.totalTime += verifyTime;
                this.stats.avgVerifyTime = this.stats.totalTime / this.stats.verifications;

                return true;
            }

            verifyFast(proof) {
                return this.verifyAlgebraicIdentity(proof.a, proof.b);
            }

            static async generateKeyPair() {
                try {
                    return await crypto.subtle.generateKey('Ed25519', true, ['sign', 'verify']);
                } catch (e) {
                    return null;
                }
            }
        }

        // Global instance
        const lmvrf = new LightweightMobileVRF();
        let keyPair = null;

        // Initialize
        (async () => {
            keyPair = await LightweightMobileVRF.generateKeyPair();
            if (!keyPair) {
                document.getElementById('browserAlert').style.display = 'block';
            }
        })();

        function log(elementId, text, className = '') {
            const element = document.getElementById(elementId);
            const span = document.createElement('span');
            if (className) span.className = className;
            span.textContent = text + '\n';
            element.appendChild(span);
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function getRarity(value) {
            const normalized = (value + 1000) / 2000;
            if (normalized < 0.01) return { name: 'LEGENDARY', color: '#ff6b6b', chance: '1%' };
            if (normalized < 0.06) return { name: 'EPIC', color: '#a55eea', chance: '5%' };
            if (normalized < 0.21) return { name: 'RARE', color: '#45aaf2', chance: '15%' };
            if (normalized < 0.51) return { name: 'UNCOMMON', color: '#26de81', chance: '30%' };
            return { name: 'COMMON', color: '#a5b1c2', chance: '49%' };
        }

        async function demoLootBox() {
            clearLog('lootboxOutput');
            log('lootboxOutput', 'üéÆ Opening loot box...', 'highlight');
            log('lootboxOutput', '');

            try {
                log('lootboxOutput', '1. Server generates random outcome...');
                const proof = await lmvrf.generate('lootbox_user_' + Date.now(), keyPair?.privateKey);
                log('lootboxOutput', '   ‚úì Random value: ' + proof.a.toFixed(4), 'success');

                log('lootboxOutput', '');
                log('lootboxOutput', '2. Mobile device verifies instantly...');
                const startVerify = performance.now();
                const isValid = await lmvrf.verify(proof, keyPair?.publicKey);
                const verifyTime = performance.now() - startVerify;

                if (isValid) {
                    log('lootboxOutput', `   ‚úì Verified in ${verifyTime.toFixed(2)}ms`, 'success');
                    
                    log('lootboxOutput', '');
                    log('lootboxOutput', '3. Determining loot rarity...');
                    const rarity = getRarity(proof.a);
                    log('lootboxOutput', `   üéÅ You got: ${rarity.name} (${rarity.chance})`, 'highlight');
                    log('lootboxOutput', '');
                    log('lootboxOutput', '‚úì Provably fair - you can verify this result!', 'success');
                } else {
                    log('lootboxOutput', '   ‚úó Verification failed!', 'error');
                }
            } catch (e) {
                log('lootboxOutput', '‚úó Error: ' + e.message, 'error');
            }
        }

        async function runBenchmark() {
            const btn = document.getElementById('benchmarkBtn');
            btn.disabled = true;
            clearLog('benchmarkOutput');
            log('benchmarkOutput', '‚ö° Running benchmark (100 iterations)...', 'highlight');
            log('benchmarkOutput', '');

            try {
                const proof = await lmvrf.generate('benchmark_' + Date.now(), keyPair?.privateKey);
                const iterations = 100;

                log('benchmarkOutput', `Running ${iterations} verifications...`);
                const startTime = performance.now();

                for (let i = 0; i < iterations; i++) {
                    await lmvrf.verify(proof, keyPair?.publicKey);
                    if (i % 20 === 0) {
                        log('benchmarkOutput', `  Progress: ${i}/${iterations}`);
                    }
                }

                const totalTime = performance.now() - startTime;
                const avgTime = totalTime / iterations;
                const pairingTime = 75; // Conservative estimate for pairing-based VRF
                const speedup = pairingTime / avgTime;
                const throughput = Math.floor(1000 / avgTime);

                log('benchmarkOutput', '');
                log('benchmarkOutput', '--- RESULTS ---', 'highlight');
                log('benchmarkOutput', `LM-VRF avg:        ${avgTime.toFixed(2)}ms`, 'success');
                log('benchmarkOutput', `Pairing VRF (est): ${pairingTime}ms`);
                log('benchmarkOutput', `Speedup:           ${speedup.toFixed(1)}√ó`, 'success');
                log('benchmarkOutput', `Throughput:        ${throughput} verifications/sec`, 'success');

                // Update stats display
                document.getElementById('avgTime').textContent = avgTime.toFixed(2);
                document.getElementById('speedup').textContent = speedup.toFixed(1) + '√ó';
                document.getElementById('throughput').textContent = throughput;
                document.getElementById('statsGrid').style.display = 'grid';

            } catch (e) {
                log('benchmarkOutput', '‚úó Error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function testAttacks() {
            clearLog('attackOutput');
            log('attackOutput', 'üõ°Ô∏è Testing attack resistance...', 'highlight');
            log('attackOutput', '');

            try {
                // Test 1: Modified algebraic identity
                log('attackOutput', 'TEST 1: Modifying algebraic values');
                const proof1 = await lmvrf.generate('attack_test_1', keyPair?.privateKey);
                log('attackOutput', '  Original: a=' + proof1.a.toFixed(4) + ', b=' + proof1.b.toFixed(4));
                
                const malicious1 = { ...proof1, a: proof1.a + 10 };
                const result1 = lmvrf.verifyFast(malicious1);
                log('attackOutput', '  Modified a by +10');
                log('attackOutput', result1 ? '  ‚úó ATTACK SUCCEEDED (bad!)' : '  ‚úì ATTACK BLOCKED', result1 ? 'error' : 'success');

                log('attackOutput', '');
                
                // Test 2: Breaking b = a + 1
                log('attackOutput', 'TEST 2: Breaking b = a + 1 relationship');
                const malicious2 = { ...proof1, b: proof1.b + 0.5 };
                const result2 = lmvrf.verifyFast(malicious2);
                log('attackOutput', '  Modified b by +0.5');
                log('attackOutput', result2 ? '  ‚úó ATTACK SUCCEEDED (bad!)' : '  ‚úì ATTACK BLOCKED', result2 ? 'error' : 'success');

                log('attackOutput', '');

                // Test 3: Random garbage values
                log('attackOutput', 'TEST 3: Random garbage values');
                const garbage = { a: Math.random() * 1000, b: Math.random() * 1000, context: 'garbage' };
                const result3 = lmvrf.verifyFast(garbage);
                log('attackOutput', '  Random a=' + garbage.a.toFixed(4) + ', b=' + garbage.b.toFixed(4));
                log('attackOutput', result3 ? '  ‚úó ATTACK SUCCEEDED (bad!)' : '  ‚úì ATTACK BLOCKED', result3 ? 'error' : 'success');

                log('attackOutput', '');
                log('attackOutput', '‚úì All attacks blocked successfully!', 'success');

            } catch (e) {
                log('attackOutput', '‚úó Error: ' + e.message, 'error');
            }
        }

        async function generateCustom() {
            const context = document.getElementById('contextInput').value || 'default_context';
            clearLog('customOutput');
            log('customOutput', 'üé≤ Generating random number...', 'highlight');
            log('customOutput', 'Context: ' + context);
            log('customOutput', '');

            try {
                const proof = await lmvrf.generate(context, keyPair?.privateKey, 0, 1000);
                
                log('customOutput', '‚úì Generation complete!', 'success');
                log('customOutput', '');
                log('customOutput', 'Results:', 'highlight');
                log('customOutput', '  Random value (a): ' + proof.a.toFixed(6));
                log('customOutput', '  Verification (b): ' + proof.b.toFixed(6));
                log('customOutput', '  Timestamp: ' + new Date(proof.timestamp).toLocaleString());
                log('customOutput', '');

                const isValid = await lmvrf.verify(proof, keyPair?.publicKey);
                log('customOutput', '‚úì Algebraic identity verified', 'success');
                if (keyPair) {
                    log('customOutput', '‚úì Signature verified', 'success');
                }

                log('customOutput', '');
                log('customOutput', 'You can use this value for:', 'highlight');
                log('customOutput', '  ‚Ä¢ Fair lottery selection');
                log('customOutput', '  ‚Ä¢ Random game events');
                log('customOutput', '  ‚Ä¢ Unpredictable outcomes');
                log('customOutput', '  ‚Ä¢ And more!');

            } catch (e) {
                log('customOutput', '‚úó Error: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
